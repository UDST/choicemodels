

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>choicemodels.mnl &mdash; ChoiceModels 0.2.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ChoiceModels
          

          
          </a>

          
            
            
              <div class="version">
                0.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../choice-table-utilities.html">Choice table utilities API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multinomial-logit.html">Multinomial Logit API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulation-utilities.html">Simulation utilities API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distance-utilities.html">Distance utilities API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ChoiceModels</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>choicemodels.mnl</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for choicemodels.mnl</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pylogit</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="kn">import</span> <span class="n">dmatrix</span>
<span class="kn">from</span> <span class="nn">statsmodels.iolib.table</span> <span class="kn">import</span> <span class="n">SimpleTable</span>

<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">MergedChoiceTable</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">pmat</span>
<span class="kn">from</span> <span class="nn">.tools.pmat</span> <span class="kn">import</span> <span class="n">PMAT</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">#####################</span>
<span class="sd">NEW CLASS DEFINITIONS</span>
<span class="sd">#####################</span>

<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="MultinomialLogit"><a class="viewcode-back" href="../../multinomial-logit.html#choicemodels.MultinomialLogit">[docs]</a><span class="k">class</span> <span class="nc">MultinomialLogit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class with methods for estimating multinomial logit discrete choice models. Each</span>
<span class="sd">    observation is a choice scenario in which a chooser selects one alternative from a</span>
<span class="sd">    choice set of two or more. The fitted parameters represent a joint optimization of</span>
<span class="sd">    utility expressions that explains observed choices based on attributes of the</span>
<span class="sd">    alternatives and of the choosers.</span>

<span class="sd">    The input data needs to be in &quot;long&quot; format, with one row for each combination of</span>
<span class="sd">    chooser and alternative. Columns contain relevant attributes and identifiers. (If the</span>
<span class="sd">    choice sets are large, sampling of alternatives should be carried out before data is</span>
<span class="sd">    passed to this class.)</span>

<span class="sd">    The class constructor supports two use cases:</span>

<span class="sd">    1. The first use case is simpler and requires fewer inputs. Each choice scenario must</span>
<span class="sd">       have the same number of alternatives, and each alternative must have the same model</span>
<span class="sd">       expression (utility equation). This is typical when the alternatives are relatively</span>
<span class="sd">       numerous and homogenous, for example with travel destination choice or household</span>
<span class="sd">       location choice.</span>

<span class="sd">       The following parameters are required: &#39;data&#39;, &#39;observation_id_col&#39;, &#39;choice_col&#39;,</span>
<span class="sd">       &#39;model_expression&#39; in Patsy format. If data is provided as a MergedChoiceTable,</span>
<span class="sd">       the observation id and choice column names can be read directly from its metadata.</span>

<span class="sd">       To fit this type of model, ChoiceModels will use its own estimation engine adapted</span>
<span class="sd">       from the UrbanSim MNL codebase.</span>

<span class="sd">       Migration from &#39;urbansim.urbanchoice&#39;: Note that these requirements differ from</span>
<span class="sd">       the old UrbanSim codebase in a couple of ways. (1) The chosen alternatives need to</span>
<span class="sd">       be indicated in a column of the estimation data table instead of in a separate</span>
<span class="sd">       matrix, and (2) in lieu of indicating the number of alternatives in each choice</span>
<span class="sd">       set, the estimation data table should include an observation id column. These</span>
<span class="sd">       changes make the API more consistent with other use cases. See the</span>
<span class="sd">       MergedChoiceTable() class for tools and code examples to help with migration.</span>

<span class="sd">    2. The second use case is more flexible. Choice scenarios can have varying numbers of</span>
<span class="sd">       alternatives, and the model expression (utility equation) can be different for</span>
<span class="sd">       distinct alternatives. This is typical when there is a small number of alternatives</span>
<span class="sd">       whose salient characteristics vary, for example with travel mode choice.</span>

<span class="sd">       The following parameters are required: &#39;data&#39;, &#39;observation_id_col&#39;,</span>
<span class="sd">       &#39;alternative_id_col&#39;, &#39;choice_col&#39;, &#39;model_expression&#39; in PyLogit format,</span>
<span class="sd">       &#39;model_labels&#39; in PyLogit format (optional).</span>

<span class="sd">       To fit this type of model, ChoiceModels will use the PyLogit estimation engine.</span>

<span class="sd">    With either use case, the model expression can include attributes of both the choosers</span>
<span class="sd">    and the alternatives. Attributes of a particular alternative may vary for different</span>
<span class="sd">    choosers (distance, for example), but this must be set up manually in the input data.</span>

<span class="sd">    Note that prediction methods are in a separate class: see MultinomialLogitResults().</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    data : pd.DataFrame or choicemodels.tools.MergedChoiceTable</span>
<span class="sd">        A table of estimation data in &quot;long&quot; format, with one row for each combination of</span>
<span class="sd">        chooser and alternative. Column labeling must be consistent with the</span>
<span class="sd">        &#39;model_expression&#39;. May include extra columns.</span>

<span class="sd">    model_expression : Patsy &#39;formula-like&#39; or PyLogit &#39;specification&#39;</span>
<span class="sd">        For the simpler use case where each choice scenario has the same number of</span>
<span class="sd">        alternatives and each alternative has the same model expression, this should be a</span>
<span class="sd">        Patsy formula representing the right-hand side of the single model expression.</span>
<span class="sd">        This can be a string or a number of other data types. See here:</span>
<span class="sd">        https://patsy.readthedocs.io/en/v0.1.0/API-reference.html#patsy.dmatrix</span>

<span class="sd">        For the more flexible use case where choice scenarios have varying numbers of</span>
<span class="sd">        alternatives or the model expessions vary, this should be a PyLogit OrderedDict</span>
<span class="sd">        model specification. See here:</span>
<span class="sd">        https://github.com/timothyb0912/pylogit/blob/master/pylogit/pylogit.py#L116-L130</span>

<span class="sd">    observation_id_col : str, optional</span>
<span class="sd">        Name of column or index containing the observation id. This should uniquely </span>
<span class="sd">        identify each distinct choice scenario. Not required if data is passed as a </span>
<span class="sd">        MergedChoiceTable.</span>

<span class="sd">    choice_col : str, optional</span>
<span class="sd">        Name of column containing an indication of which alternative has been chosen in</span>
<span class="sd">        each scenario. Values should evaluate as binary: 1/0, True/False, etc. Not</span>
<span class="sd">        required if data is passed as a MergedChoiceTable.</span>

<span class="sd">    model_labels : PyLogit &#39;names&#39;, optional</span>
<span class="sd">        If the model expression is a PyLogit OrderedDict, you can provide a corresponding</span>
<span class="sd">        OrderedDict of labels. See here:</span>
<span class="sd">        https://github.com/timothyb0912/pylogit/blob/master/pylogit/pylogit.py#L151-L165</span>

<span class="sd">    alternative_id_col : str, optional</span>
<span class="sd">        Name of column or index containing the alternative id. This is only required if </span>
<span class="sd">        the model expression varies for different alternatives. Not required if data is </span>
<span class="sd">        passed as a MergedChoiceTable.</span>

<span class="sd">    initial_coefs : numeric or list-like of numerics, optional</span>
<span class="sd">        Initial coefficients (beta values) to begin the optimization process with. Provide</span>
<span class="sd">        a single value for all coefficients, or an array containing a value for each</span>
<span class="sd">        one being estimated. If None, initial coefficients will be 0.</span>

<span class="sd">    weights : 1D array, optional</span>
<span class="sd">        NOT YET IMPLEMENTED - Estimation weights.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">model_expression</span><span class="p">,</span> <span class="n">observation_id_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">choice_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">model_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alternative_id_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_coefs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span> <span class="o">=</span> <span class="n">model_expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_id_col</span> <span class="o">=</span> <span class="n">observation_id_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_id_col</span> <span class="o">=</span> <span class="n">alternative_id_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_choice_col</span> <span class="o">=</span> <span class="n">choice_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_labels</span> <span class="o">=</span> <span class="n">model_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span> <span class="o">=</span> <span class="n">initial_coefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">MergedChoiceTable</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_observation_id_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">observation_id_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_id_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">alternative_id_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_choice_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">choice_col</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span> <span class="o">=</span> <span class="s1">&#39;PyLogit&#39;</span>

            <span class="c1"># parse initial_coefs</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span><span class="p">,</span>
                                                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span> <span class="o">=</span> <span class="s1">&#39;ChoiceModels&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_id_col</span><span class="p">]]</span><span class="o">.</span>\
                                    <span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numalts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numobs</span>

        <span class="k">return</span>

    
<div class="viewcode-block" id="MultinomialLogit.fit"><a class="viewcode-back" href="../../multinomial-logit.html#choicemodels.MultinomialLogit.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the model using maximum likelihood estimation. Uses either the ChoiceModels</span>
<span class="sd">        or PyLogit estimation engine as appropriate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MultinomialLogitResults() object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span> <span class="o">==</span> <span class="s1">&#39;PyLogit&#39;</span><span class="p">):</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">pylogit</span><span class="o">.</span><span class="n">create_choice_model</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span>
                                            <span class="n">obs_id_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_id_col</span><span class="p">,</span>
                                            <span class="n">alt_id_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_id_col</span><span class="p">,</span>
                                            <span class="n">choice_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choice_col</span><span class="p">,</span>
                                            <span class="n">specification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">,</span>
                                            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_labels</span><span class="p">,</span>
                                            <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;MNL&#39;</span><span class="p">)</span>

            <span class="n">m</span><span class="o">.</span><span class="n">fit_mle</span><span class="p">(</span><span class="n">init_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_coefs</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">MultinomialLogitResults</span><span class="p">(</span><span class="n">estimation_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span><span class="p">,</span>
                                              <span class="n">model_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">,</span>
                                              <span class="n">results</span> <span class="o">=</span> <span class="n">m</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span> <span class="o">==</span> <span class="s1">&#39;ChoiceModels&#39;</span><span class="p">):</span>

            <span class="n">dm</span> <span class="o">=</span> <span class="n">dmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>

            <span class="n">chosen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_choice_col</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numalts</span><span class="p">))</span>

            <span class="n">log_lik</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">mnl_estimate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dm</span><span class="p">),</span> <span class="n">chosen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numalts</span><span class="p">)</span>

            <span class="n">result_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">log_lik</span><span class="p">,</span>
                                 <span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">fit</span><span class="p">,</span>
                                 <span class="n">x_names</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">MultinomialLogitResults</span><span class="p">(</span><span class="n">estimation_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span><span class="p">,</span>
                                              <span class="n">model_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_expression</span><span class="p">,</span>
                                              <span class="n">results</span> <span class="o">=</span> <span class="n">result_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">estimation_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &#39;ChoiceModels&#39; or &#39;PyLogit&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_engine</span></div>


<div class="viewcode-block" id="MultinomialLogitResults"><a class="viewcode-back" href="../../multinomial-logit.html#choicemodels.MultinomialLogitResults">[docs]</a><span class="k">class</span> <span class="nc">MultinomialLogitResults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The results class represents a fitted model. It can report the model fit, generate</span>
<span class="sd">    choice probabilties, etc.</span>
<span class="sd">    </span>
<span class="sd">    A full-featured results object is returned by MultinomialLogit.fit(). A results object</span>
<span class="sd">    with more limited functionality can also be built directly from fitted parameters and</span>
<span class="sd">    a model expression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_expression : str or OrderedDict</span>
<span class="sd">        Patsy &#39;formula-like&#39; (str) or PyLogit &#39;specification&#39; (OrderedDict).</span>
<span class="sd">    </span>
<span class="sd">    results : dict or object, optional</span>
<span class="sd">        Raw results as currently provided by the estimation engine. This should be</span>
<span class="sd">        replaced with a more consistent and comprehensive set of inputs.</span>

<span class="sd">    fitted_parameters : list of floats, optional</span>
<span class="sd">        If not provided, these will be extracted from the raw results.</span>

<span class="sd">    estimation_engine : str, optional</span>
<span class="sd">        &#39;ChoiceModels&#39; (default) or &#39;PyLogit&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_expression</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fitted_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">estimation_engine</span><span class="o">=</span><span class="s1">&#39;ChoiceModels&#39;</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">fitted_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">estimation_engine</span> <span class="o">==</span> <span class="s1">&#39;ChoiceModels&#39;</span><span class="p">):</span>
                <span class="n">fitted_parameters</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_engine</span> <span class="o">=</span> <span class="n">estimation_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_expression</span> <span class="o">=</span> <span class="n">model_expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_parameters</span> <span class="o">=</span> <span class="n">fitted_parameters</span>
        
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_fit</span><span class="p">()</span>

    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_fit</span><span class="p">()</span>

    
<div class="viewcode-block" id="MultinomialLogitResults.get_raw_results"><a class="viewcode-back" href="../../multinomial-logit.html#choicemodels.MultinomialLogitResults.get_raw_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_raw_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the raw results as provided by the estimation engine. Dict or object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span></div>

    
<div class="viewcode-block" id="MultinomialLogitResults.probabilities"><a class="viewcode-back" href="../../multinomial-logit.html#choicemodels.MultinomialLogitResults.probabilities">[docs]</a>    <span class="k">def</span> <span class="nf">probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate predicted probabilities for a table of choice scenarios, using the fitted</span>
<span class="sd">        parameters stored in the results object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : choicemodels.tools.MergedChoiceTable</span>
<span class="sd">            Long-format table of choice scenarios. TO DO - accept other data formats.</span>
<span class="sd">        </span>
<span class="sd">        Expected class parameters</span>
<span class="sd">        -------------------------</span>
<span class="sd">        self.model_expression : patsy string</span>
<span class="sd">        self.fitted_parameters : list of floats</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.Series with indexes matching the input</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TO DO - make sure this handles pylogit case</span>
        
        <span class="c1"># TO DO - does MergedChoiceTable guarantee that alternatives for a single scenario</span>
        <span class="c1"># are consecutive? seems like a requirement here; should document it</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">numalts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample_size</span>  <span class="c1"># TO DO - make this an official MCT param</span>
        
        <span class="n">dm</span> <span class="o">=</span> <span class="n">dmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_expression</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># utility is sum of data values times fitted betas</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_parameters</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dm</span><span class="p">))</span>
        
        <span class="c1"># reshape so axis 0 lists alternatives and axis 1 lists choosers</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="n">numalts</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">numalts</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    
        <span class="c1"># scale the utilities to make exponentiation easier</span>
        <span class="c1"># https://stats.stackexchange.com/questions/304758/softmax-overflow</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">u</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">exponentiated_utility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">sum_exponentiated_utility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exponentiated_utility</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">probs</span> <span class="o">=</span> <span class="n">exponentiated_utility</span> <span class="o">/</span> <span class="n">sum_exponentiated_utility</span>
        
        <span class="c1"># convert back to ordering of the input data</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>  <span class="c1"># adds indexes</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">prob</span></div>
    
    
<div class="viewcode-block" id="MultinomialLogitResults.report_fit"><a class="viewcode-back" href="../../multinomial-logit.html#choicemodels.MultinomialLogitResults.report_fit">[docs]</a>    <span class="k">def</span> <span class="nf">report_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a report of the model estimation results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimation_engine</span> <span class="o">==</span> <span class="s1">&#39;PyLogit&#39;</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get_statsmodels_summary</span><span class="p">()</span><span class="o">.</span><span class="n">as_text</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimation_engine</span> <span class="o">==</span> <span class="s1">&#39;ChoiceModels&#39;</span><span class="p">):</span>

            <span class="c1"># Pull out individual results components</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span>
            <span class="n">ll_null</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>

            <span class="n">rho_bar_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;rho_bar_squared&#39;</span><span class="p">]</span>
            <span class="n">rho_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;rho_squared&#39;</span><span class="p">]</span>
            <span class="n">df_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;df_model&#39;</span><span class="p">]</span>
            <span class="n">df_resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;df_resid&#39;</span><span class="p">]</span>
            <span class="n">num_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;num_obs&#39;</span><span class="p">]</span>
            <span class="n">bic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;bic&#39;</span><span class="p">]</span>
            <span class="n">aic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;aic&#39;</span><span class="p">]</span>

            <span class="n">x_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;x_names&#39;</span><span class="p">]</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">std_errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;Std. Error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">t_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;T-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">p_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;P-Values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">time_now</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">date_now</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="n">summary_table</span><span class="p">(</span><span class="n">dep_var</span> <span class="o">=</span> <span class="s1">&#39;chosen&#39;</span><span class="p">,</span>
                                           <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;Multinomial Logit&#39;</span><span class="p">,</span>
                                           <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Maximum Likelihood&#39;</span><span class="p">,</span>
                                           <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">ll</span><span class="p">,</span>
                                           <span class="n">null_log_likelihood</span> <span class="o">=</span> <span class="n">ll_null</span><span class="p">,</span>
                                           <span class="n">rho_squared</span> <span class="o">=</span> <span class="n">rho_squared</span><span class="p">,</span>
                                           <span class="n">rho_bar_squared</span> <span class="o">=</span> <span class="n">rho_bar_squared</span><span class="p">,</span>
                                           <span class="n">df_model</span> <span class="o">=</span> <span class="n">df_model</span><span class="p">,</span>
                                           <span class="n">df_resid</span> <span class="o">=</span> <span class="n">df_resid</span><span class="p">,</span>
                                           <span class="n">x_names</span> <span class="o">=</span> <span class="n">x_names</span><span class="p">,</span>
                                           <span class="n">coefs</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">,</span>
                                           <span class="n">std_errs</span> <span class="o">=</span> <span class="n">std_errs</span><span class="p">,</span>
                                           <span class="n">t_scores</span> <span class="o">=</span> <span class="n">t_scores</span><span class="p">,</span>
                                           <span class="n">p_values</span> <span class="o">=</span> <span class="n">p_values</span><span class="p">,</span>
                                           <span class="n">bic</span> <span class="o">=</span> <span class="n">bic</span><span class="p">,</span>
                                           <span class="n">aic</span> <span class="o">=</span> <span class="n">aic</span><span class="p">,</span>
                                           <span class="n">num_obs</span> <span class="o">=</span> <span class="n">num_obs</span><span class="p">,</span>
                                           <span class="n">time</span> <span class="o">=</span> <span class="n">time_now</span><span class="p">(),</span>
                                           <span class="n">date</span> <span class="o">=</span> <span class="n">date_now</span><span class="p">())</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">as_text</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">body</span><span class="o">.</span><span class="n">as_text</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output</span></div></div>


<span class="k">def</span> <span class="nf">summary_table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">time</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">aic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df_resid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">df_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rho_squared</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rho_bar_squared</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">log_likelihood</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">null_log_likelihood</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">coefs</span><span class="o">=</span><span class="p">[],</span>
                  <span class="n">std_errs</span><span class="o">=</span><span class="p">[],</span> <span class="n">t_scores</span><span class="o">=</span><span class="p">[],</span><span class="n">p_values</span><span class="o">=</span><span class="p">[],</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a summary table of estimation results using Statsmodels SimpleTable. Still a</span>
<span class="sd">    work in progress.</span>

<span class="sd">    SimpleTable is maddening to work with, so it would be nice to find an alternative. It</span>
<span class="sd">    would need to support pretty-printing of formatted tables to plaintext and ideally</span>
<span class="sd">    also to HTML and Latex.</span>

<span class="sd">    At first it looked like we could use Statsmodels&#39;s summary table generator directly</span>
<span class="sd">    (iolib.summary.Summary), but this requires a Statsmodels results object as input and</span>
<span class="sd">    doesn&#39;t document which properties are pulled from it. PyLogit reverse engineered this</span>
<span class="sd">    for use in get_statsmodels_summary() -- so it&#39;s possible, but could be hard to</span>
<span class="sd">    maintain in the long run.</span>

<span class="sd">    We can&#39;t use PyLogit&#39;s summary table generator either. It requires a PyLogit</span>
<span class="sd">    model class as input, and we can&#39;t create one from results parameters. Oh well!</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">format_str</span><span class="p">):</span>
        <span class="c1"># Custom numeric-&gt;string formatter that gracefully accepts null values</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;CHOICEMODELS ESTIMATION RESULTS&quot;</span>

    <span class="n">top_left</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;Dep. Var.:&#39;</span><span class="p">,</span> <span class="n">dep_var</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Model:&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Method:&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Date:&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;Time:&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;AIC:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">aic</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="s1">&#39;BIC:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">bic</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">)]]</span>

    <span class="n">top_right</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;No. Observations:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">num_obs</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,}</span><span class="s2">&quot;</span><span class="p">)],</span>
                 <span class="p">[</span><span class="s1">&#39;Df Residuals:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">df_resid</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,}</span><span class="s2">&quot;</span><span class="p">)],</span>
                 <span class="p">[</span><span class="s1">&#39;Df Model:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">df_model</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,}</span><span class="s2">&quot;</span><span class="p">)],</span>
                 <span class="p">[</span><span class="s1">&#39;Pseudo R-squ.:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">rho_squared</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">)],</span>
                 <span class="p">[</span><span class="s1">&#39;Pseudo R-bar-squ.:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">rho_bar_squared</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">)],</span>
                 <span class="p">[</span><span class="s1">&#39;Log-Likelihood:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">)],</span>
                 <span class="p">[</span><span class="s1">&#39;LL-Null:&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">null_log_likelihood</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">)]]</span>

    <span class="c1"># Zip into a single table (each side needs same number of entries)</span>
    <span class="n">header_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">top_right</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_left</span><span class="p">))]</span>

    <span class="c1"># See end of statsmodels.iolib.table.py for formatting options</span>
    <span class="n">header_fmt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">table_dec_below</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">data_aligns</span> <span class="o">=</span> <span class="s1">&#39;lrlr&#39;</span><span class="p">,</span>
                      <span class="n">colwidths</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
                      <span class="n">colsep</span> <span class="o">=</span> <span class="s1">&#39;   &#39;</span><span class="p">,</span>
                      <span class="n">empty_cell</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">SimpleTable</span><span class="p">(</span><span class="n">header_cells</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">txt_fmt</span><span class="o">=</span><span class="n">header_fmt</span><span class="p">)</span>

    <span class="n">col_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;std err&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;P&gt;|z|&#39;</span><span class="p">,</span> <span class="s1">&#39;Conf. Int.&#39;</span><span class="p">]</span>
    <span class="n">row_labels</span> <span class="o">=</span> <span class="n">x_names</span>

    <span class="n">body_cells</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fmt</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{:,.4f}</span><span class="s2">&quot;</span><span class="p">),</span>
                   <span class="n">fmt</span><span class="p">(</span><span class="n">std_errs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">),</span>
                   <span class="n">fmt</span><span class="p">(</span><span class="n">t_scores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">),</span>
                   <span class="n">fmt</span><span class="p">(</span><span class="n">p_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{:,.3f}</span><span class="s2">&quot;</span><span class="p">),</span>
                   <span class="s1">&#39;&#39;</span><span class="p">]</span>  <span class="c1"># conf int placeholder</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_names</span><span class="p">))]</span>

    <span class="n">body_fmt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">table_dec_below</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span>
                    <span class="n">header_align</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span>
                    <span class="n">data_aligns</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span>
                    <span class="n">colwidths</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="n">colsep</span> <span class="o">=</span> <span class="s1">&#39;   &#39;</span><span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="n">SimpleTable</span><span class="p">(</span><span class="n">body_cells</span><span class="p">,</span>
                       <span class="n">headers</span> <span class="o">=</span> <span class="n">col_labels</span><span class="p">,</span>
                       <span class="n">stubs</span> <span class="o">=</span> <span class="n">row_labels</span><span class="p">,</span>
                       <span class="n">txt_fmt</span> <span class="o">=</span> <span class="n">body_fmt</span><span class="p">)</span>

    <span class="c1"># Ideally we&#39;d want to append these into a single table, but I can&#39;t get it to work</span>
    <span class="c1"># without completely messing up the formatting..</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">#############################</span>
<span class="sd">ORIGINAL FUNCTION DEFINITIONS</span>
<span class="sd">#############################</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># right now MNL can only estimate location choice models, where every equation</span>
<span class="c1"># is the same</span>
<span class="c1"># it might be better to use stats models for a non-location choice problem</span>

<span class="c1"># data should be column matrix of dimensions NUMVARS x (NUMALTS*NUMOBVS)</span>
<span class="c1"># beta is a row vector of dimensions 1 X NUMVARS</span>


<span class="k">def</span> <span class="nf">mnl_probs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">numalts</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start: calculate MNL probabilities&#39;</span><span class="p">)</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numalts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Number of alternatives is zero&quot;</span><span class="p">)</span>
    <span class="n">utilities</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">numalts</span><span class="p">,</span> <span class="n">utilities</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">numalts</span><span class="p">)</span>

    <span class="c1"># https://stats.stackexchange.com/questions/304758/softmax-overflow</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">exponentiated_utility</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">inftoval</span><span class="p">(</span><span class="mf">1e20</span><span class="p">)</span>
        <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">clamptomin</span><span class="p">(</span><span class="mf">1e-300</span><span class="p">)</span>
    <span class="n">sum_exponentiated_utility</span> <span class="o">=</span> <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">divide_by_row</span><span class="p">(</span>
        <span class="n">sum_exponentiated_utility</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">probs</span><span class="o">.</span><span class="n">nantoval</span><span class="p">(</span><span class="mf">1e-300</span><span class="p">)</span>
        <span class="n">probs</span><span class="o">.</span><span class="n">clamptomin</span><span class="p">(</span><span class="mf">1e-300</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: calculate MNL probabilities&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">probs</span>


<span class="k">def</span> <span class="nf">get_hessian</span><span class="p">(</span><span class="n">derivative</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivative</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">derivative</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">get_standard_error</span><span class="p">(</span><span class="n">hessian</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">hessian</span><span class="p">))</span>

<span class="c1"># data should be column matrix of dimensions NUMVARS x (NUMALTS*NUMOBVS)</span>
<span class="c1"># beta is a row vector of dimensions 1 X NUMVARS</span>


<span class="k">def</span> <span class="nf">mnl_loglik</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcgrad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">stderr</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start: calculate MNL log-likelihood&#39;</span><span class="p">)</span>
    <span class="n">numvars</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span>
    <span class="n">numobs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">numvars</span> <span class="o">//</span> <span class="n">numalts</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">typ</span><span class="p">)</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="n">mnl_probs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">numalts</span><span class="p">)</span>

    <span class="c1"># lcgrad is the special gradient for the latent class membership model</span>
    <span class="k">if</span> <span class="n">lcgrad</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">weights</span>
        <span class="n">gradmat</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">gradmat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">weights</span><span class="p">:</span>
            <span class="n">gradmat</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradmat</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">multiply_by_row</span><span class="p">(</span>
                <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">gradmat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
        <span class="n">gradmat</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multiply_by_row</span><span class="p">(</span><span class="n">gradmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>
        <span class="n">gradmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">numvars</span><span class="p">,</span> <span class="n">numalts</span> <span class="o">*</span> <span class="n">numobs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_standard_error</span><span class="p">(</span><span class="n">get_hessian</span><span class="p">(</span><span class="n">gradmat</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()))</span>

    <span class="n">chosen</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">numalts</span><span class="p">,</span> <span class="n">numobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">probs</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span> <span class="o">==</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">():</span>
            <span class="n">loglik</span> <span class="o">=</span> <span class="p">((</span><span class="n">probs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loglik</span> <span class="o">=</span> <span class="p">((</span><span class="n">probs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">multiply_by_row</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loglik</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span>
            <span class="n">chosen</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">loglik</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
        <span class="n">loglik</span><span class="p">,</span> <span class="n">gradarr</span> <span class="o">=</span> <span class="n">loglik</span><span class="o">.</span><span class="n">get_mat</span><span class="p">(),</span> <span class="n">gradarr</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loglik</span> <span class="o">=</span> <span class="n">loglik</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gradarr</span><span class="o">.</span><span class="n">get_mat</span><span class="p">(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gradarr</span><span class="o">.</span><span class="n">size</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: calculate MNL log-likelihood&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">loglik</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">gradarr</span>


<span class="k">def</span> <span class="nf">mnl_estimate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">GPU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coeffrange</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                 <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcgrad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate coefficients of the MNL model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : 2D array</span>
<span class="sd">        The data are expected to be in &quot;long&quot; form where each row is for</span>
<span class="sd">        one alternative. Alternatives are in groups of `numalts` rows per</span>
<span class="sd">        choosers. Alternatives must be in the same order for each chooser.</span>
<span class="sd">    chosen : 2D array</span>
<span class="sd">        This boolean array has a row for each chooser and a column for each</span>
<span class="sd">        alternative. The column ordering for alternatives is expected to be</span>
<span class="sd">        the same as their row ordering in the `data` array.</span>
<span class="sd">        A one (True) indicates which alternative each chooser has chosen.</span>
<span class="sd">    numalts : int</span>
<span class="sd">        The number of alternatives.</span>
<span class="sd">    GPU : bool, optional</span>
<span class="sd">    coeffrange : tuple of floats, optional</span>
<span class="sd">        Limits of (min, max) to which coefficients are clipped.</span>
<span class="sd">    weights : ndarray, optional</span>
<span class="sd">    lcgrad : bool, optional</span>
<span class="sd">    beta : 1D array, optional</span>
<span class="sd">        Any initial guess for the coefficients.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    log_likelihood : dict</span>
<span class="sd">        Dictionary of log-likelihood values describing the quality of</span>
<span class="sd">        the model fit. The  following keys is entered into `log_likelihood`.</span>
<span class="sd">        </span>
<span class="sd">        aic : float</span>
<span class="sd">            Akaike information criterion for an estimated model. </span>
<span class="sd">            aic =  -2 * log_likelihood + 2 * num_estimated_parameters </span>
<span class="sd">        </span>
<span class="sd">        bic : float</span>
<span class="sd">            Bayesian information criterion for an estimated model. </span>
<span class="sd">            bic = -2 * log_likelihood + log(num_observations) * num_parameters</span>
<span class="sd">        </span>
<span class="sd">        num_obs : int</span>
<span class="sd">            Number of observations in the model.</span>

<span class="sd">        df_model : int</span>
<span class="sd">            The number of parameters estimated in this model.</span>

<span class="sd">        df_resid : int</span>
<span class="sd">            The number of observations minus the number of estimated parameters.</span>

<span class="sd">        llnull : float</span>
<span class="sd">            Value of the constant-only loglikelihood</span>
<span class="sd">        </span>
<span class="sd">        ll : float</span>
<span class="sd">            Value of the loglikelihood</span>

<span class="sd">        rho_squared  : float</span>
<span class="sd">            McFadden&#39;s pseudo-R-squared. </span>
<span class="sd">            rho_squared = 1.0 - final_log_likelihood / null_log_likelihood</span>

<span class="sd">        rho_bar_squared : float</span>
<span class="sd">            rho_bar_squared = 1.0 - ((final_log_likelihood - num_est_parameters) /</span>
<span class="sd">                             null_log_likelihood)</span>


<span class="sd">    fit_parameters : pandas.DataFrame</span>
<span class="sd">        Table of fit parameters with columns &#39;Coefficient&#39;, &#39;Std. Error&#39;,</span>
<span class="sd">        &#39;T-Score&#39;, and &#39;P-Values. Each row corresponds to a column in `data` and are given</span>
<span class="sd">        in the same order as in `data`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    scipy.optimize.fmin_l_bfgs_b : The optimization routine used.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;start: MNL fit with len(data)=</span><span class="si">{}</span><span class="s1"> and numalts=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">numalts</span><span class="p">))</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">GPU</span> <span class="k">else</span> <span class="s1">&#39;cuda&#39;</span>

    <span class="n">numvars</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">numobs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">numalts</span>

    <span class="k">if</span> <span class="n">chosen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">numobs</span><span class="p">,</span> <span class="n">numalts</span><span class="p">))</span>  <span class="c1"># used for latent classes</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span>

    <span class="n">data</span><span class="p">,</span> <span class="n">chosen</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atype</span><span class="p">),</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">atype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numvars</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">coeffrange</span><span class="p">]</span> <span class="o">*</span> <span class="n">numvars</span>

    <span class="c1"># scipy optimization for MNL fit</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start: scipy optimization for MNL fit&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">lcgrad</span><span class="p">)</span>
    <span class="n">bfgs_result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fmin_l_bfgs_b</span><span class="p">(</span><span class="n">mnl_loglik</span><span class="p">,</span>
                                               <span class="n">beta</span><span class="p">,</span>
                                               <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                               <span class="n">fprime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                               <span class="n">factr</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                               <span class="n">approx_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: scipy optimization for MNL fit&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bfgs_result</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;warnflag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;mnl did not converge correctly: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="n">bfgs_result</span><span class="p">)</span>
    
    <span class="n">beta</span> <span class="o">=</span> <span class="n">bfgs_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">mnl_loglik</span><span class="p">(</span>
        <span class="n">beta</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lcgrad</span><span class="o">=</span><span class="n">lcgrad</span><span class="p">)</span>

    <span class="n">l0beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numvars</span><span class="p">)</span>
    <span class="n">l0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">mnl_loglik</span><span class="p">(</span><span class="n">l0beta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">mnl_loglik</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ll_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">l0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rho_squared</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">ll</span> <span class="o">/</span> <span class="n">ll_null</span>
    <span class="n">rho_bar_squared</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">((</span><span class="n">ll</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span> <span class="o">/</span><span class="n">ll_null</span><span class="p">)</span>
    <span class="n">num_obs</span> <span class="o">=</span> <span class="n">numobs</span>
    <span class="n">df_resid</span> <span class="o">=</span> <span class="n">numobs</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="n">stderr</span><span class="p">))</span>
    <span class="n">bic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ll</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">numobs</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">aic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>

    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;null&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">l0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">l1</span> <span class="o">/</span> <span class="n">l0</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;rho_bar_squared&#39;</span><span class="p">:</span> <span class="n">rho_bar_squared</span><span class="p">,</span>
        <span class="s1">&#39;rho_squared&#39;</span><span class="p">:</span> <span class="n">rho_squared</span><span class="p">,</span>
        <span class="s1">&#39;df_model&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span>
        <span class="s1">&#39;df_resid&#39;</span><span class="p">:</span> <span class="n">df_resid</span><span class="p">,</span>
        <span class="s1">&#39;num_obs&#39;</span><span class="p">:</span><span class="n">numobs</span><span class="p">,</span>
        <span class="s1">&#39;bic&#39;</span><span class="p">:</span><span class="n">bic</span><span class="p">,</span>
        <span class="s1">&#39;aic&#39;</span><span class="p">:</span><span class="n">aic</span><span class="p">}</span>

    <span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Coefficient&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
        <span class="s1">&#39;Std. Error&#39;</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span>
        <span class="s1">&#39;T-Score&#39;</span><span class="p">:</span> <span class="n">beta</span> <span class="o">/</span> <span class="n">stderr</span><span class="p">,</span>
        <span class="s1">&#39;P-Values&#39;</span> <span class="p">:</span> <span class="n">p_values</span> <span class="p">})</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: MNL fit&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_likelihood</span><span class="p">,</span> <span class="n">fit_parameters</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Urban Data Science Toolkit.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>